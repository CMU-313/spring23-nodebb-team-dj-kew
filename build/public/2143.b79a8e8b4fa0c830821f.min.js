"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[2143],{22905:(w,S,g)=>{var v,m;v=[g(7927)],m=function(h){const p={};return p.init=function(l,a){let e=null;a=a||{},a.privilege=a.privilege||"topics:read",a.states=a.states||["watching","notwatching","ignoring"];let t=[];Array.isArray(a.localCategories)&&(t=a.localCategories.map(s=>({...s}))),a.selectedCids=a.selectedCids||ajaxify.data.selectedCids||[];const n=l.find('[component="category-selector-search"]');if(!n.length)return;const i=n.parent('[component="category/dropdown"]').length>0||n.parent('[component="category-selector"]').length>0;l.on("show.bs.dropdown",function(){i&&(l.find(".dropdown-toggle").addClass("hidden"),n.removeClass("hidden"));function s(){const d=n.find("input").val();d.length>1||!d&&!e?r(d,function(C){e=e||C,o(C)}):!d&&e&&(e.forEach(function(C){C.selected=a.selectedCids.includes(C.cid)}),o(e))}n.on("click",function(d){d.preventDefault(),d.stopPropagation()}),n.find("input").val("").on("keyup",utils.debounce(s,300)),s()}),l.on("shown.bs.dropdown",function(){n.find("input").focus()}),l.on("hide.bs.dropdown",function(){i&&(l.find(".dropdown-toggle").removeClass("hidden"),n.addClass("hidden")),n.off("click"),n.find("input").off("keyup")});function r(s,d){socket.emit("categories.categorySearch",{search:s,query:utils.params(),parentCid:a.parentCid||0,selectedCids:a.selectedCids,privilege:a.privilege,states:a.states,showLinks:a.showLinks},function(C,N){if(C)return h.error(C);d(t.concat(N))})}function o(s){app.parseAndTranslate(a.template,{categoryItems:s.slice(0,200),selectedCategory:ajaxify.data.selectedCategory,allCategoriesUrl:ajaxify.data.allCategoriesUrl},function(d){l.find('[component="category/list"]').replaceWith(d.find('[component="category/list"]')),l.find('[component="category/list"] [component="category/no-matches"]').toggleClass("hidden",!!s.length)})}},p}.apply(S,v),m!==void 0&&(w.exports=m)},50548:(w,S,g)=>{var v,m;v=[g(22905),g(31369),g(85233)],m=function(h,p,l){const a={};return a.init=function(e,t){if(!e||!e.length)return;t=t||{};const n=t.onSelect||function(){};t.states=t.states||["watching","notwatching","ignoring"],t.template="partials/category-selector",l.fire("action:category.selector.options",{el:e,options:t}),h.init(e,t);const i={el:e,selectedCategory:null};e.on("click","[data-cid]",function(){const o=$(this);if(o.hasClass("disabled"))return!1;i.selectCategory(o.attr("data-cid")),n(i.selectedCategory)});const r=i.el.find('[component="category-selector-selected"]').html();return i.selectCategory=function(o){const s=i.el.find('[data-cid="'+o+'"]');i.selectedCategory={cid:o,name:s.attr("data-name")},s.length?i.el.find('[component="category-selector-selected"]').html(s.find('[component="category-markup"]').html()):i.el.find('[component="category-selector-selected"]').html(r)},i.getSelectedCategory=function(){return i.selectedCategory},i.getSelectedCid=function(){return i.selectedCategory?i.selectedCategory.cid:0},i},a.modal=function(e){e=e||{},e.onSelect=e.onSelect||function(){},e.onSubmit=e.onSubmit||function(){},app.parseAndTranslate("admin/partials/categories/select-category",{message:e.message},function(t){const n=p.dialog({title:e.title||"[[modules:composer.select_category]]",message:t,buttons:{save:{label:"[[global:select]]",className:"btn-primary",callback:r}}}),i=a.init(n.find('[component="category-selector"]'),e);function r(o){return o.preventDefault(),i.selectedCategory&&(e.onSubmit(i.selectedCategory),n.modal("hide")),!1}e.openOnLoad&&n.on("shown.bs.modal",function(){n.find(".dropdown-toggle").dropdown("toggle")}),n.find("form").on("submit",r)})},a}.apply(S,v),m!==void 0&&(w.exports=m)},98755:(w,S,g)=>{var v,m;v=[g(50548),g(27145),g(74344)],m=function(h,p,l){var a={},e;a.init=function(r,o){var s=r.find(".category-list-container");s.length&&(r.on("action:composer.resize",function(){t(r)}),a.updateTaskbar(r,o),e=h.init(s.find('[component="category-selector"]'),{privilege:"topics:create",states:["watching","notwatching","ignoring"],onSelect:function(d){o.hasOwnProperty("cid")&&i(r,o,d)}}),e&&(o.cid&&o.category?e.selectedCategory={cid:o.cid,name:o.category.name}:ajaxify.data.template.compose&&ajaxify.data.selectedCategory&&(e.selectedCategory={cid:ajaxify.data.cid,name:ajaxify.data.selectedCategory}),r.find(".category-name").translateText(e.selectedCategory?e.selectedCategory.name:"[[modules:composer.select_category]]").on("click",function(){h.modal({privilege:"topics:create",states:["watching","notwatching","ignoring"],openOnLoad:!0,showLinks:!1,onSelect:function(d){r.find(".category-name").text(d.name),e.selectCategory(d.cid),o.hasOwnProperty("cid")&&i(r,o,d)}})}),t(r)))};function t(r){r.find('.category-list-container [component="category-selector"]').toggleClass("dropup",r.outerHeight()<$(window).height()/2)}a.getSelectedCid=function(){var r;return e&&(r=e.getSelectedCategory()),r?r.cid:0},a.updateTaskbar=function(r,o){parseInt(o.cid,10)&&l.get(`/categories/${o.cid}`,{}).then(function(s){n(r,s)})};function n(r,o){if(o){var s=r.attr("data-uuid");p.update("composer",s,{image:o.backgroundImage,"background-color":o.bgColor,icon:o.icon&&o.icon.slice(3)})}}async function i(r,o,s){o.cid=s.cid;const d=await window.fetch(`${config.relative_path}/api/category/${s.cid}`).then(C=>C.json());o.category=d,n(r,d),g.e(3913).then(function(){var C=[g(98166),g(88186)];(function(N,P){N.onChangeCategory(d),P.onChangeCategory(r,o,s.cid,d),$(window).trigger("action:composer.changeCategory",{postContainer:r,postData:o,selectedCategory:s,categoryData:d})}).apply(null,C)}).catch(g.oe)}return a}.apply(S,v),m!==void 0&&(w.exports=m)},22143:(w,S,g)=>{var v,m;v=[g(83713),g(98755),g(32230),g(7927),g(33371),g(86569)],m=function(h,p,l,a,e){var t={inProgress:{}},n="";t.initialize=function(c){s(c),d(c),i(c),r(c),l.translate("[[modules:composer.uploading, "+0+"%]]",function(f){n=f})};function i(c){var f=$('.composer[data-uuid="'+c+'"]');f.find("#files").on("change",function(u){var E=(u.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);E&&P({files:E,post_uuid:c,route:"/api/post/upload"})})}function r(c){var f=$('.composer[data-uuid="'+c+'"]');f.on("click",".topic-thumb-clear-btn",function(u){f.find("input#topic-thumb-url").val("").trigger("change"),o(f.find("input#topic-thumb-file")),$(this).addClass("hide"),u.preventDefault()}),f.on("paste change keypress","input#topic-thumb-url",function(){var u=$(this);setTimeout(function(){var E=u.val();E?f.find(".topic-thumb-clear-btn").removeClass("hide"):(o(f.find("input#topic-thumb-file")),f.find(".topic-thumb-clear-btn").addClass("hide")),f.find("img.topic-thumb-preview").attr("src",E)},100)})}function o(c){c.wrap("<form />").closest("form").get(0).reset(),c.unwrap()}function s(c){var f=$('.composer[data-uuid="'+c+'"]');e.handleDragDrop({container:f,callback:function(u){P({files:u.files,post_uuid:c,route:"/api/post/upload",formData:u.formData})}})}function d(c){var f=$('.composer[data-uuid="'+c+'"]');e.handlePaste({container:f,callback:function(u){P({files:u.files,fileNames:u.fileNames,post_uuid:c,route:"/api/post/upload",formData:u.formData})}})}function C(c){return c.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function N(c,f,u){return c.slice(0,f)+u+c.slice(f)}function P(c){var f=[...c.files],u=c.post_uuid,E=$('.composer[data-uuid="'+u+'"]'),_=E.find("textarea"),j=_.val(),x=E.find("#fileForm"),M=!1;x.attr("action",config.relative_path+c.route);var R=p.getSelectedCid();!R&&ajaxify.data.cid&&(R=ajaxify.data.cid);var b=0,k=!1;for(b=0;b<f.length;++b)if(k=f[b].type.match(/image./),k&&!app.user.privileges["upload:post:image"]||!k&&!app.user.privileges["upload:post:file"])return a.error("[[error:no-privileges]]");var F=[];for(b=0;b<f.length;++b){if(F.push(b+"_"+Date.now()+"_"+(c.fileNames?c.fileNames[b]:f[b].name)),k=f[b].type.match(/image./),f[b].size>parseInt(config.maximumFileSize,10)*1024)return x[0].reset(),a.error("[[error:file-too-big, "+config.maximumFileSize+"]]");j=N(j,_.getCursorPosition(),(k?"!":"")+"["+F[b]+"]("+n+") ")}x.length&&E.find('[data-action="post"]').prop("disabled",!0),_.val(j),$(window).trigger("action:composer.uploadStart",{post_uuid:u,files:F.map(function(T,A){return{filename:T.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(f[A].type)}}),text:n}),x.off("submit").submit(function(){function T(A,D,y){var L;y&&(L=A.replace(/^\d+_\d{13}_/,""));var U=_.val(),I=new RegExp(C(A)+"]\\([^)]+\\)","g");_.val(U.replace(I,(L||A)+"]("+D+")")),$(window).trigger("action:composer.uploadUpdate",{post_uuid:u,filename:A,text:D})}return t.inProgress[u]=t.inProgress[u]||[],t.inProgress[u].push(1),c.formData&&c.formData.append("cid",R),$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:c.formData,data:{cid:R},error:function(A){M=!0,E.find('[data-action="post"]').prop("disabled",!1);const D=B(A,u);for(var y=0;y<f.length;++y)T(F[y],D,!0);h.render(E)},uploadProgress:function(A,D,y,L){l.translate("[[modules:composer.uploading, "+L+"%]]",function(U){if(!M)for(var I=0;I<f.length;++I)T(F[I],U)})},success:function(A){const D=A.response.images;if(M=!0,D&&D.length)for(var y=0;y<D.length;++y)D[y].filename=F[y].replace(/^\d+_\d{13}_/,""),D[y].isImage=/image./.test(f[y].type),T(F[y],D[y].url,!0);h.render(E),_.focus(),E.find('[data-action="post"]').prop("disabled",!1),$(window).trigger("action:composer.upload",{post_uuid:u,files:D})},complete:function(){x[0].reset(),t.inProgress[u].pop()}}),!1}),x.submit()}function B(c,f){var u=c.responseJSON&&(c.responseJSON.error||c.responseJSON.status&&c.responseJSON.status.message)||"[[error:parse-error]]";return c&&c.status===413&&(u=c.statusText||"Request Entity Too Large"),a.error(u),$(window).trigger("action:composer.uploadError",{post_uuid:f,message:u}),u}return t}.apply(S,v),m!==void 0&&(w.exports=m)},33371:(w,S,g)=>{var v,m;v=[g(7927)],m=function(h){const p={};return p.init=function(l){const a=l.uploadFormEl;a.length&&(a.attr("action",config.relative_path+l.route),l.dragDropAreaEl&&p.handleDragDrop({container:l.dragDropAreaEl,callback:function(e){p.ajaxSubmit({uploadForm:a,upload:e,callback:l.callback})}}),l.pasteEl&&p.handlePaste({container:l.pasteEl,callback:function(e){p.ajaxSubmit({uploadForm:a,upload:e,callback:l.callback})}}))},p.handleDragDrop=function(l){let a=!1;const e=l.container,t=l.container.find(".imagedrop");e.on("dragenter",function(){a||(t.css("top","0px"),t.css("height",e.height()+"px"),t.css("line-height",e.height()+"px"),t.show(),t.on("dragleave",function(){t.hide(),t.off("dragleave")}))}),t.on("drop",function(r){r.preventDefault();const o=r.originalEvent.dataTransfer.files;if(o.length){let d;if(window.FormData){d=new FormData;for(var s=0;s<o.length;++s)d.append("files[]",o[s],o[s].name)}l.callback({files:o,formData:d})}return t.hide(),!1});function n(i){return i.preventDefault(),!1}$(document).off("dragstart").on("dragstart",function(){a=!0}).off("dragend").on("dragend, mouseup",function(){a=!1}),t.on("dragover",n),t.on("dragenter",n)},p.handlePaste=function(l){l.container.on("paste",function(e){const t=(e.clipboardData||e.originalEvent.clipboardData||{}).items,n=[],i=[];let r=null;window.FormData&&(r=new FormData),[].forEach.call(t,function(o){const s=o.getAsFile();if(s){const d=utils.generateUUID()+"-"+s.name;r&&r.append("files[]",s,d),n.push(s),i.push(d)}}),n.length&&l.callback({files:n,fileNames:i,formData:r})})},p.ajaxSubmit=function(l){const a=[...l.upload.files];for(let t=0;t<a.length;++t){const n=a[t].type.match(/image./);if(n&&!app.user.privileges["upload:post:image"]||!n&&!app.user.privileges["upload:post:file"])return h.error("[[error:no-privileges]]");if(a[t].size>parseInt(config.maximumFileSize,10)*1024)return l.uploadForm[0].reset(),h.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const e=Date.now();l.uploadForm.off("submit").on("submit",function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:l.upload.formData,error:function(t){let n=t.responseJSON&&(t.responseJSON.error||t.responseJSON.status&&t.responseJSON.status.message)||"[[error:parse-error]]";t&&t.status===413&&(n=t.statusText||"Request Entity Too Large"),h.error(n),h.remove(e)},uploadProgress:function(t,n,i,r){h.alert({alert_id:e,message:"[[modules:composer.uploading, "+r+"%]]"})},success:function(t){const n=t.response.images;if(n&&n.length)for(var i=0;i<n.length;++i)n[i].filename=a[i].name,n[i].isImage=/image./.test(a[i].type);l.callback(n)},complete:function(){l.uploadForm[0].reset(),setTimeout(h.remove,100,e)}}),!1}),l.uploadForm.submit()},p}.apply(S,v),m!==void 0&&(w.exports=m)}}]);
