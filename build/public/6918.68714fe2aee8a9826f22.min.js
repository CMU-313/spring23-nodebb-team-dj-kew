"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[6918,7913],{47913:(E,y,o)=>{var m,u;m=[o(74344),o(7927)],u=function(h,O){var r={},f;r.init=function(e,n){var t=e.find(".draft-icon");function i(){I(),f=setTimeout(function(){A(e,t,n)},1e3)}e.on("keyup","textarea, input.handle, input.title",i),e.on("click",'input[type="checkbox"]',i),e.on("thumb.uploaded",i),t.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){var a=[];try{a=localStorage.getItem("drafts:open"),a=JSON.parse(a)||[]}catch{console.warn("[composer/drafts] Could not read list of open/available drafts"),a=[]}a.length&&a.forEach(function(l){r.updateVisibility("open",l)})}),r.migrateGuest(),r.migrateThumbs(...arguments)};function I(){f&&(clearTimeout(f),f=0)}r.getDraft=function(e){return console.warn("[composer/drafts] drafts.getDraft is deprecated! Use drafts.get() instead."),localStorage.getItem(e)};function c(e){return parseInt(e,10)>0?localStorage:sessionStorage}r.get=function(e){var n=e.split(":")[1],t=c(n),i={text:t.getItem(e)};return["cid","title","tags","uuid"].forEach(function(a){const l=t.getItem(e+":"+a);l&&(i[a]=l)}),parseInt(n,10)||(i.handle=t.getItem(e+":handle")),$(window).trigger("action:composer.drafts.get",{save_id:e,draft:i,storage:t}),i};function A(e,n,t){if(g(app.user.uid?"localStorage":"sessionStorage")&&t&&t.save_id&&e.length){const d=e.find("input.title"),s=d&&d.val();var i=e.find("textarea").val(),a=c(app.user.uid);if(t.hasOwnProperty("cid")&&!t.save_id.endsWith(":cid:"+t.cid)&&(r.removeDraft(t.save_id),t.save_id=t.save_id.replace(/cid:\d+$/,"cid:"+t.cid)),i.length||s&&s.length){if(a.setItem(t.save_id,i),a.setItem(`${t.save_id}:uuid`,e.attr("data-uuid")),t.hasOwnProperty("cid")){const v=e.find("input.tags").val();a.setItem(t.save_id+":tags",v),a.setItem(t.save_id+":title",s)}if(!app.user.uid){var l=e.find("input.handle").val();a.setItem(t.save_id+":handle",l)}$(window).trigger("action:composer.drafts.save",{storage:a,postData:t,postContainer:e}),n.toggleClass("active",!0)}else r.removeDraft(t.save_id)}}r.removeDraft=function(e){if(!e)return;I(),r.updateVisibility("available",e),r.updateVisibility("open",e);var n=e.split(":")[1],t=c(n);Object.keys(t).filter(a=>a.startsWith(e)).forEach(a=>t.removeItem(a))},r.updateVisibility=function(e,n,t){if(!(!g(app.user.uid?"localStorage":"sessionStorage")||!n)){var i=[];try{i=localStorage.getItem("drafts:"+e),i=i?JSON.parse(i):[]}catch{console.warn("[composer/drafts] Could not read list of open drafts"),i=[]}var a=i.indexOf(n);t&&a===-1?i.push(n):!t&&a!==-1&&i.splice(a,1),localStorage.setItem("drafts:"+e,JSON.stringify(i))}},r.migrateGuest=function(){if(g("localStorage")&&app.user.uid){var e=/^composer:\d+:\w+:\d+(:\w+)?$/,n=Object.keys(sessionStorage).filter(function(a){return e.test(a)}),t=new Set([]),i=n.map(function(a){var l=a.split(":");return l[1]=app.user.uid,t.add(l.slice(0,4).join(":")),l.join(":")});return n.forEach(function(a,l){localStorage.setItem(i[l],sessionStorage.getItem(a)),sessionStorage.removeItem(a)}),t.forEach(function(a){r.updateVisibility("available",a,1)}),t}},r.migrateThumbs=function(e,n){if(!app.uid)return;const t=e.attr("data-uuid"),i=r.get(n.save_id);i&&i.uuid&&h.put(`/topics/${i.uuid}/thumbs`,{tid:t}).then(()=>{Promise.all([o.e(6177),o.e(2526),o.e(4074),o.e(2143),o.e(5482),o.e(1521),o.e(2023)]).then(function(){var a=[o(44541)];(function(l){l.updateThumbCount(t,e)}).apply(null,a)}).catch(o.oe)})},r.loadOpen=function(){if(!(ajaxify.data.template.login||ajaxify.data.template.register)){var e,n=[];try{e=localStorage.getItem("drafts:available"),n=localStorage.getItem("drafts:open"),e=JSON.parse(e)||[],n=JSON.parse(n)||[]}catch{console.warn("[composer/drafts] Could not read list of open/available drafts"),e=[],n=[]}e.length&&e.forEach(function(t){if(t){var i=t.split(":"),a=i[1],l=i[2],d=i[3],s=r.get(t);if(n.indexOf(t)===-1&&parseInt(app.user.uid,10)===parseInt(a,10)){if(!s||s.text&&s.title&&!s.text.title&&!s.text.length){r.updateVisibility("available",t),r.updateVisibility("open",t);return}Promise.all([o.e(6177),o.e(2526),o.e(4074),o.e(2143),o.e(5482),o.e(1521),o.e(2023)]).then(function(){var v=[o(44541)];(function(p){l==="cid"?p.newTopic({cid:d,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(s.handle),title:utils.escapeHTML(s.title),body:utils.escapeHTML(s.text),tags:String(s.tags||"").split(",")}):l==="tid"?h.get("/topics/"+d,{},function(S,R){if(S)return O.error(S);p.newReply(d,void 0,R.title,utils.escapeHTML(s.text))}):l==="pid"&&p.editPost(d)}).apply(null,v)}).catch(o.oe)}}})}};function g(e){var n;try{n=window[e];var t="__storage_test__";return n.setItem(t,t),n.removeItem(t),!0}catch(i){return i instanceof DOMException&&(i.code===22||i.code===1014||i.name==="QuotaExceededError"||i.name==="NS_ERROR_DOM_QUOTA_REACHED")&&n&&n.length!==0}}return r}.apply(y,m),u!==void 0&&(E.exports=u)}}]);
